<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
  <head>
    <title>Book Session</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <style>
      .form-card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        margin: 30px auto;
        max-width: 500px;
      }

      .form-field {
        margin-bottom: 20px;
      }

      .form-field label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }

      .form-field select {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div th:replace="fragments/header :: site-header"></div>
    <main class="main-content">
      <div class="form-card">
        <form th:action="@{/book-session}" method="post">
          <h1 class="heading-1">Book a Session</h1>
          <div th:if="${error}" class="error-message" th:text="${error}"></div>
          <div
            th:if="${success}"
            class="success-message"
            th:text="${success}"
          ></div>

          <!-- Department -->
          <div class="form-field mt-20">
            <label for="departmentSelect">Department</label>
            <select id="departmentSelect" name="departmentId">
              <option value="">Select Department</option>
              <option
                th:each="dept : ${departments}"
                th:value="${dept.id}"
                th:text="${dept.name}"
              ></option>
            </select>
          </div>

          <!-- Tutor -->
          <div class="form-field">
            <label for="tutorSelect">Tutor</label>
            <select id="tutorSelect" name="tutorId">
              <option value="">Select Tutor (or Anyone)</option>
              <option value="anyone">Anyone</option>
              <option
                th:each="tutor : ${tutors}"
                th:value="${tutor.id}"
                th:data-department-id="${tutor.departmentId}"
                th:text="${tutor.firstName + ' ' + tutor.lastName}"
              ></option>
            </select>
          </div>

          <!-- Timeslot -->
          <div class="form-field">
            <label for="sessionSelect">Timeslot</label>
            <select id="sessionSelect" name="sessionId" required>
              <option value="">Select Session</option>
              <option
                th:each="s : ${sessions}"
                th:value="${s.id}"
                th:data-tutor-id="${s.tutorId}"
                th:data-department-id="${s.departmentId}"
                th:text="${s.date + ' ' + s.timeSlot}"
              ></option>
            </select>
          </div>

          <button type="submit" class="button size-sm">Book Session</button>
        </form>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const departmentSelect = document.getElementById("departmentSelect");
        const tutorSelect = document.getElementById("tutorSelect");
        const sessionSelect = document.getElementById("sessionSelect");

        const allSessionOptions = Array.from(
          sessionSelect.querySelectorAll("option")
        ).slice(1); // skip "Select Session"
        const allTutorOptions = Array.from(
          tutorSelect.querySelectorAll("option")
        ).slice(2); // skip "Select Tutor" and "Anyone"

        function filterTutors() {
          const selectedDept = departmentSelect.value;
          allTutorOptions.forEach((option) => {
            const tutorDept = option.getAttribute("data-department-id");
            option.style.display =
              !selectedDept || tutorDept === selectedDept ? "" : "none";
          });
          tutorSelect.value = "";
          filterSessions();
        }

        function filterSessions() {
          const selectedDept = departmentSelect.value;
          const selectedTutor = tutorSelect.value;

          sessionSelect.innerHTML = '<option value="">Select Session</option>'; // reset
          const filtered = allSessionOptions.filter((option) => {
            const sessionDept = option.getAttribute("data-department-id");
            const sessionTutor = option.getAttribute("data-tutor-id");

            // Match department
            if (selectedDept && sessionDept !== selectedDept) return false;

            // Match tutor (skip if 'anyone')
            if (
              selectedTutor &&
              selectedTutor !== "anyone" &&
              sessionTutor !== selectedTutor
            )
              return false;

            return true;
          });

          filtered.forEach((option) =>
            sessionSelect.appendChild(option.cloneNode(true))
          );
        }

        departmentSelect.addEventListener("change", filterTutors);
        tutorSelect.addEventListener("change", filterSessions);
      });
    </script>
  </body>
</html>
